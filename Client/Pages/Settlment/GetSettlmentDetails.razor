@page "/get-settlement/{SettlementId:guid}"
@using CapManagement.Client.Pages.Earning
@using CapManagement.Shared.DtoModels.SettlementDtoModels
@using CapManagement.Shared.DtoModels.EarningDtoModels
@using CapManagement.Shared.Models
@using CapManagement.Client.IServiceClient
@using Radzen
@using Radzen.Blazor
@inject ISettlmentClientService SettlementServiceClient
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject DialogService DialogService
@using Microsoft.JSInterop; 
@using System.IO;


<RadzenHeading Size="H3" Text="Settlement Details" class="mb-3" />
@if (isLoading)
{
    <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
}
else if (settlement == null)
{
    <RadzenCard class="text-center p-4">
        <RadzenIcon Icon="warning" Style="font-size: 48px; color: var(--rz-base-500);" />
        <p class="mt-2">Settlement not found.</p>
    </RadzenCard>
}
else
{

    <RadzenButton Text="Download PDF"
                  Icon="picture_as_pdf"
                  Click="@DownloadPdf"
                  Style="margin-bottom: 20px;"
                  ButtonStyle="ButtonStyle.Primary" />

    <RadzenCard class="mb-4">
        <RadzenRow>
            <RadzenColumn Size="12">
                <h5>Settlement Information</h5>
                <RadzenRow>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Settlement ID" />
                        <p>@settlement.SettlementId</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Company ID" />
                        <p>@settlement.CompanyId</p>
                    </RadzenColumn>

                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Driver Name" />
                        <p>@(settlement.Contracts?.FirstOrDefault()?.DriverName ?? "N/A")</p>

                    </RadzenColumn>


                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Period Start" />
                        <p>@settlement.PeriodStart.ToString("yyyy-MM-dd")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Period End" />
                        <p>@settlement.PeriodEnd.ToString("yyyy-MM-dd")</p>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow class="mt-2">
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Status" />
                        <p>@settlement.Status</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Extra Costs (€)" />
                        <p>@settlement.ExtraCosts.ToString("C")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Gross Amount (€)" />
                        <p>@settlement.GrossAmount.ToString("C")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Rent Deduction (€)" />
                        <p>@settlement.RentDeduction.ToString("C")</p>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow class="mt-2">
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Net Payout (€)" />
                        <p>@settlement.NetPayout.ToString("C")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Confirmed By Driver" />
                        <p>@(settlement.ConfirmedByDriver ? "Yes" : "No")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Confirmed At" />
                        <p>@(settlement.ConfirmedAt?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</p>
                    </RadzenColumn>
                    <RadzenColumn Size="3">
                        <RadzenLabel Text="Description" />
                        <p>@(settlement.Description ?? "N/A")</p>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <RadzenHeading Size="H4" Text="Platform Earnings" class="mb-3" />
    @if (!settlement.Earnings.Any())
    {
        <RadzenCard class="text-center p-4">
            <RadzenIcon Icon="info" Style="font-size: 48px; color: var(--rz-base-500);" />
            <p class="mt-2">No earnings associated with this settlement.</p>
        </RadzenCard>
    }
    else
    {
        @foreach (var platform in platforms)
        {
            var platformEarnings = settlement.Earnings.Where(e => e.Platform == platform).ToList();
            if (platformEarnings.Any())
            {
             
            
                <RadzenCard class="mb-4">
                 
                   
                    <RadzenHeading Size="H5" Text="@($"{platform} Earnings")" class="mb-3" />
                    <RadzenDataGrid @ref="grid" Data="@platformEarnings" TItem="EarningDto" AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center">
                        <Columns>
                            <RadzenDataGridColumn TItem="EarningDto" Property="WeekStart" Title="Week Start">
                                <Template Context="earning">
                                    @earning.WeekStart.ToString("yyyy-MM-dd")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EarningDto" Property="WeekEnd" Title="Week End">
                                <Template Context="earning">
                                    @earning.WeekEnd.ToString("yyyy-MM-dd")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EarningDto" Property="GrossIncome" Title="Gross Income (€)" FormatString="{0:C}">
                                <Template Context="earning">
                                    @earning.GrossIncome.ToString("C")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EarningDto" Property="BtwPercentage" Title="BTW (%)" FormatString="{0:N2}">
                                <Template Context="earning">
                                    @earning.BtwPercentage.ToString("N2")%
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EarningDto" Property="BtwAmount" Title="BTW Amount (€)" FormatString="{0:C}">
                                <Template Context="earning">
                                    @earning.BtwAmount.ToString("C")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EarningDto" Property="NetIncome" Title="Net Income (€)" FormatString="{0:C}">
                                <Template Context="earning">
                                    @earning.NetIncome.ToString("C")
                                </Template>


                            </RadzenDataGridColumn>

                            <RadzenDataGridColumn TItem="EarningDto" Title="Actions" Width="120px">
                                <Template Context="earning">
                                    <RadzenButton Text="Edit"
                                                  Icon="edit"
                                                  Size="ButtonSize.Small"
                                                  ButtonStyle="ButtonStyle.Primary"
                                                  Click="@(() => OpenEditEarningDialog(earning.EarningId, earning.CompanyId))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                    <RadzenRow class="mt-3">
                        <RadzenColumn Size="12">
                            <p><strong>Total Net for @platform: </strong>@platformEarnings.Sum(e => e.NetIncome).ToString("C")</p>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>
            }
        }
    }
}

@code {
    [Parameter] public Guid SettlementId { get; set; }
   

    private readonly Guid _companyId = Guid.Parse("9D176E43-E0FF-4755-B130-625189f3991b");
    private SettlementDto? settlement;
    private List<PlatformType> platforms = Enum.GetValues<PlatformType>().Cast<PlatformType>().ToList();
    private bool isLoading = true;
    private RadzenDataGrid<EarningDto>? grid;


    [Parameter] public EarningDto earning { get; set; }
    protected override async Task OnInitializedAsync()
    {
        await LoadSettlement();
    }

    private async Task LoadSettlement()
    {
        isLoading = true;
        try
        {
            var settlementResponse = await SettlementServiceClient.GetSettlementByIdAsync(SettlementId, _companyId);
            if (settlementResponse.Success)
            {
                settlement = settlementResponse.Data;
                // Earnings are included in the SettlementDto
                // No need for separate earnings fetch
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error",
                        Detail = string.Join("; ", settlementResponse.Errors ?? new List<string> { "Unknown error" }),
                        Duration = 3000
                    });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = $"Failed to load settlement: {ex.Message}",
                    Duration = 3000
                });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }


    async Task OpenEditEarningDialog(Guid earningId, Guid companyId)
    {
        var result = await DialogService.OpenAsync<EditEarningDialog>(
            "Edit Earning",
            new Dictionary<string, object>
                {
            { "EarningId", earningId },
            { "CompanyId", companyId }
                },
            new DialogOptions { Width = "600px", Height = "auto" }
        );
    }



    private async Task DownloadPdf()
    {
        try
        {
            var pdfBytes = await SettlementServiceClient.DownloadSettlementPdfAsync(SettlementId, _companyId);
           
            Console.WriteLine($"pdfBytes length: {pdfBytes.Length}");
            var base64 = Convert.ToBase64String(pdfBytes);
            await JSRuntime.InvokeVoidAsync(
                "downloadPdfFile",
                $"Settlement_{SettlementId}.pdf",
                "application/pdf",
                base64
            );
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Download Started",
                    Detail = "PDF is downloading..."
                });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Download Error",
                    Detail = $"Failed to download PDF: {ex.Message}"
                });
        }
    }

  
}