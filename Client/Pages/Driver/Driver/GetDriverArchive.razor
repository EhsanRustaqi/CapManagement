@page "/archived-driver"
@inject IDriverSericeClient DriverClientService
@inject NotificationService NotificationService
@inject DialogService DialogService
@using CapManagement.Client.IServiceClient
@using CapManagement.Client.ServiceClient
@using CapManagement.Shared.DtoModels.DriverDtoModels
@using CapManagement.Shared.Models
@using Radzen
@using Radzen.Blazor
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.ComponentModel.Design

<RadzenDataGrid @ref="companiesGrid" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" AllowPaging="true" PageSize="5" AllowSorting="true"
                Data="@drivers" Count="@totalCount" LoadData="@LoadData" TItem="DriverDto">
 @*    <Columns>
        <RadzenDataGridColumn Width="50px" Title="#" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
            <Template Context="data">
                @(drivers.IndexOf(data) + ((pageNumber - 1) * pageSize) + 1)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="DriverName" Title="Driver Name">
            <Template Context="Driver">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="DriverName" Title="DriverName" />


        <RadzenDataGridColumn Property="LastName" Title="LastName" />
        <RadzenDataGridColumn Property="VatNumber" Title="VAT Number" />


        <RadzenDataGridColumn Property="Address" Title="Address" />
        <RadzenDataGridColumn Property="CreatedAt" Title="Created" FormatString="{0:d}" />
        <RadzenDataGridColumn Property="IsActive" Title="Status" />
        <RadzenDataGridColumn Width="160px" Title="Actions" Filterable="false" Sortable="false">
            <Template Context="Driver">
                <RadzenButton Icon="refresh" Text="Restore" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                              Click="@(async args => await ConfirmRestore(Driver.DriverId, Driver.DriverName))" />
            </Template>
        </RadzenDataGridColumn>

    </Columns> *@

    <Columns>
        <RadzenDataGridColumn Width="50px" Title="#" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
            <Template Context="data">
                @(drivers.IndexOf(data) + ((pageNumber - 1) * pageSize) + 1)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="DriverName" Title="Name" />
        <RadzenDataGridColumn Property="LastName" Title="LastName" />
        <RadzenDataGridColumn Property="LicenseNumber" Title="License Number" />
        <RadzenDataGridColumn Property="Phonenumber" Title="Phone Number" />
        <RadzenDataGridColumn Property="DateOfBirth" Title="DOB" FormatString="{0:yyyy-MM-dd}" />
        <RadzenDataGridColumn Property="IsActive" Title="Status" />
        <RadzenDataGridColumn Width="160px" Title="Actions" Filterable="false" Sortable="false">
            <Template Context="driver">
                <RadzenButton Icon="refresh" Text="Restore" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                              Click="@(async args => await ConfirmRestore(driver.DriverId, driver.DriverName))" />
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

@code {
    private RadzenDataGrid<DriverDto>? companiesGrid;
    private List<DriverDto> drivers = new List<DriverDto>(); // Changed to List<DriverDto>
    private int totalCount;
    private int pageNumber = 1;
    private int pageSize = 5;
    private bool isLoading;
    private bool isDisposed;

    // Define your companyId here
    private Guid companyId = Guid.Parse("9D176E43-E0FF-4755-B130-625189F3991B");


    protected override async Task OnInitializedAsync()
    {
        if (isDisposed) return;

        try
        {
            await LoadData(new LoadDataArgs { Skip = 0, Top = pageSize });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error on initialization: {ex.Message}, StackTrace: {ex.StackTrace}");
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Initialization Error",
                    Detail = ex.Message,
                    Duration = 4000
                });
        }
    }

    private async Task LoadData(LoadDataArgs args)
    {
        if (isDisposed || isLoading) return;

        isLoading = true;
        try
        {
            Console.WriteLine($"LoadData triggered: Skip={args.Skip}, Top={args.Top}, OrderBy={args.OrderBy}, Filter={args.Filter}");
            if (args.Skip.HasValue && args.Top.HasValue && args.Top.Value > 0)
            {
                pageNumber = (args.Skip.Value / args.Top.Value) + 1;
                pageSize = args.Top.Value;
            }
            else
            {
                pageNumber = 1;
                pageSize = 5;
            }
            Console.WriteLine($"Loading archived data: PageNumber={pageNumber}, PageSize={pageSize}");
            var result = await DriverClientService.GetArchivedDriversAsync(
         companyId: companyId,
         pageNumber: pageNumber,
         pageSize: pageSize
     );

            if (result != null && result.Success)
            {
                drivers = result.Data?.Data ?? new List<DriverDto>();
                totalCount = result.Data?.TotalItems ?? 0;
                // Console.WriteLine($"Loaded {drivers.Count} archived companies: {JsonSerializer.Serialize(drivers)}");
                if (!isDisposed && companiesGrid != null)
                {
                    await companiesGrid.Reload();
                }
            }
            else
            {
                var errors = result?.Errors ?? new List<string> { "Result is null" };
                Console.WriteLine($"Failed to load archived data: {JsonSerializer.Serialize(errors)}");
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error Loading Archived driver",
                        Detail = string.Join("; ", errors),
                        Duration = 4000
                    });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading archived data: {ex.Message}, StackTrace: {ex.StackTrace}");
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error Loading Archived Companies",
                    Detail = ex.Message,
                    Duration = 4000
                });
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ConfirmRestore(Guid DriverId, string DriverName)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to restore '{DriverName}'?",
            "Confirm Restore",
            new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" }
        );

        if (confirmed == true)
        {
            var result = await DriverClientService.RestoreDriverAsync(DriverId, companyId);
            if (result != null && result.Success)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Driver Restored",
                        Detail = $"'{DriverName}' has been restored successfully.",
                        Duration = 4000
                    });

                // Refresh archived list
                await LoadData(new LoadDataArgs { Skip = (pageNumber - 1) * pageSize, Top = pageSize });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Restore Failed",
                        Detail = string.Join("; ", result?.Errors ?? new List<string> { "Unknown error" }),
                        Duration = 4000
                    });
            }
        }
    }



}