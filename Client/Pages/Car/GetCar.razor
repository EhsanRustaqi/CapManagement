@page "/GetCar"
@inject ICarServiceClient CarClientService
@inject NotificationService NotificationService
@inject DialogService DialogService
@using CapManagement.Client.IServiceClient
@using CapManagement.Client.ServiceClient
@using CapManagement.Shared.DtoModels.CarDtoModels
@using CapManagement.Shared.Models
@using Radzen
@using Radzen.Blazor
@using System.Text.Json


<RadzenButton Text="Add Car" Icon="add_circle" ButtonStyle="ButtonStyle.Primary"
              Click="@(async args => await OpenCreateDialog())" Style="margin-top:20px" />

@* <RadzenDataGrid @ref="CarsGrid" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand"
                AllowPaging="true" PageSize="5" AllowSorting="true"
                Data="@Cars" Count="@totalCount" LoadData="@LoadData" TItem="CarDto"> *@



<RadzenDataGrid @ref="CarsGrid"
                Data="@Cars"
                Count="@totalCount"
                LoadData="@LoadData"
                TItem="CarDto"
                AllowPaging="true"
                PagerHorizontalAlign="HorizontalAlign.Center"
                AllowSorting="true"
                AllowMultiColumnSorting="true"
                AllowFiltering="true"
                FilterMode="FilterMode.Advanced"
                PageSize="10">
    <Columns>
        <RadzenDataGridColumn Width="50px" Title="#" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
            <Template Context="data">
                @(Cars.IndexOf(data) + ((pageNumber - 1) * pageSize) + 1)
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Brand" Title="Brand" />
        <RadzenDataGridColumn Property="Model" Title="Model" />
        <RadzenDataGridColumn Property="NumberPlate" Title="NumberPlate" />
        <RadzenDataGridColumn Property="Year" Title="Year" />
        <RadzenDataGridColumn TItem="CarDto" Property="Color" Title="Color" />
        <RadzenDataGridColumn TItem="CarDto" Property="VehicleType" Title="Vehicle Type" />
        <RadzenDataGridColumn TItem="CarDto" Property="FuelType" Title="Fuel Type" />
        <RadzenDataGridColumn TItem="CarDto" Property="NumberOfDoors" Title="Doors" />
        <RadzenDataGridColumn TItem="CarDto" Property="NumberOfSeats" Title="Seats" />
        <RadzenDataGridColumn TItem="CarDto" Property="EngineCapacity" Title="Engine (cc)" />
        <RadzenDataGridColumn TItem="CarDto" Property="EmptyWeight" Title="Weight (kg)" />
        <RadzenDataGridColumn TItem="CarDto" Property="ApkExpirationDate" Title="APK Expiry" />
        <RadzenDataGridColumn Property="Status" Title="Status"  />
      
        <RadzenDataGridColumn Width="160px" Title="Actions" Filterable="false" Sortable="false">
            <Template Context="Car">


                <RadzenButton Text="View" Icon="visibility" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                              Click="@(args => DialogService.OpenAsync<ViewCarDialog>(
          "Car Details",
          new Dictionary<string, object>() { { "CarId", Car.CarId } },
          new DialogOptions() { Width = "600px", Height = "500px" }))" />


                       @*         <RadzenButton Icon="edit" Text="Edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                Click="@(() => EditCar(Car.CarId, Car.Brand))" />  *@



                <RadzenButton Icon="archive" Text="Archive" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                              Click="@(() => ConfirmArchive(Car.CarId, Car.Brand))" />
            </Template> 
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private RadzenDataGrid<CarDto>? CarsGrid;
    private List<CarDto> Cars = new();
    private int totalCount;
    private int pageNumber = 1;
    private int pageSize = 10;
    private bool isLoading;
    private bool isDisposed;
    private Guid companyId = Guid.Parse("9D176E43-E0FF-4755-B130-625189F3991B"); // Seeded CompanyId

    protected override async Task OnInitializedAsync()
    {
        if (isDisposed) return;
        await LoadData(new LoadDataArgs { Skip = 0, Top = pageSize });
    }





    // private async Task LoadData(LoadDataArgs args)
    // {
    //     if (isDisposed || isLoading) return;
    //     isLoading = true;
    //     try
    //     {
    //         if (args.Skip.HasValue && args.Top.HasValue && args.Top.Value > 0)
    //         {
    //             pageNumber = (args.Skip.Value / args.Top.Value) + 1;
    //             pageSize = args.Top.Value;
    //         }
    //         var result = await CarClientService.GetCarsAsync(companyId, pageNumber, pageSize);
    //         if (result != null && result.Success)
    //         {
    //             Cars = result.Data?.Data ?? new List<CarDto>();
    //             totalCount = result.Data?.TotalItems ?? 0;
    //             if (!isDisposed && CarsGrid != null)
    //             {
    //                 await CarsGrid.Reload();
    //             }
    //         }
    //         else
    //         {
    //             NotificationService.Notify(new NotificationMessage
    //                 {
    //                     Severity = NotificationSeverity.Error,
    //                     Summary = "Error Loading Cars",
    //                     Detail = string.Join("; ", result?.Errors ?? new List<string> { "Unknown error" }),
    //                     Duration = 4000
    //                 });
    //         }
    //     }
    //     catch (Exception ex)
    //     {
    //         NotificationService.Notify(new NotificationMessage
    //             {
    //                 Severity = NotificationSeverity.Error,
    //                 Summary = "Exception",
    //                 Detail = ex.Message,
    //                 Duration = 4000
    //             });
    //     }
    //     finally
    //     {
    //         isLoading = false;
    //     }
    // }
    private async Task LoadData(LoadDataArgs args)
    {
        if (isDisposed || isLoading) return;
        isLoading = true;
        try
        {
            if (args.Skip.HasValue && args.Top.HasValue && args.Top.Value > 0)
            {
                pageNumber = (args.Skip.Value / args.Top.Value) + 1;
                pageSize = args.Top.Value;
            }

            // Log for debugging
            Console.WriteLine($"LoadData - orderBy: {args.OrderBy}, filter: {args.Filter}");

            // Pass orderBy and filter (companyId is Guid)
            var result = await CarClientService.GetCarsAsync(companyId, pageNumber, pageSize, args.OrderBy, args.Filter);
            if (result != null && result.Success)
            {
                Cars = result.Data?.Data ?? new List<CarDto>();
                totalCount = result.Data?.TotalItems ?? 0;
                if (!isDisposed && CarsGrid != null)
                {
                    await CarsGrid.Reload();
                }
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error Loading Cars",
                        Detail = string.Join("; ", result?.Errors ?? new List<string> { "Unknown error" }),
                        Duration = 4000
                    });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Exception",
                    Detail = ex.Message,
                    Duration = 4000
                });
        }
        finally
        {
            isLoading = false;
        }
    }




    private async Task ConfirmArchive(Guid CarId, string CarName)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to archive Car '{CarName}'?",
            "Confirm Archive",
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" }
        );
        if (confirmed == true)
        {
            var result = await CarClientService.ArchiveCarAsync(CarId, companyId);
            if (result != null && result.Success)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Car Archived",
                        Detail = $"Car '{CarName}' archived successfully.",
                        Duration = 4000
                    });
                await LoadData(new LoadDataArgs { Skip = (pageNumber - 1) * pageSize, Top = pageSize });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error Archiving Car",
                        Detail = string.Join("; ", result?.Errors ?? new List<string> { "Unknown error" }),
                        Duration = 4000
                    });
            }
        }
    }





    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateCarDialog>(
            "Create Car", // <-- fixed title
            new Dictionary<string, object>
                {
            { "OnCarCreated", EventCallback.Factory.Create<CreateCarDto>(this, CreateCar) } // <-- fixed type + prop name
                },
            new DialogOptions() { Width = "600px", Height = "400px", Resizable = true, Draggable = true });
    }

    private async Task CreateCar(CreateCarDto newCar)
    {
        var result = await CarClientService.CreateCarsAsync(newCar);

        if (result != null && result.Success)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Car created successfully!",
                    Duration = 4000
                });

            await CarsGrid.Reload();
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to create car.",
                    Duration = 4000
                });
        }

        if (result != null && result.Success)
        {
            await LoadData(new LoadDataArgs { Skip = 0, Top = pageSize });
        }

    }





    private Guid _companyId = Guid.Parse("9D176E43-E0FF-4755-B130-625189F3991B");



    private async Task EditCar(Guid CarId, string CarName)
    {
        var Car = await CarClientService.GetCarByIdAsync(CarId, companyId);
        if (Car == null || !Car.Success)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = Car?.Errors?.Any() == true ? string.Join("; ", Car.Errors) : "Car not found.",
                    Duration = 4000
                });
            return;
        }

        var parameters = new Dictionary<string, object>
        {
            { "Car", Car.Data },
            { "OnSave", new Action<CarDto>(async (updatedCar) =>
                {
                    var result = await CarClientService.UpdateCarAsync(updatedCar);
                    if (result.Success)
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Success,
                            Summary = "Car Updated",
                            Detail = $"Car '{updatedCar.Brand}' updated successfully.",
                            Duration = 4000
                        });
                        await LoadData(new LoadDataArgs { Skip = (pageNumber - 1) * pageSize, Top = pageSize });
                    }
                    else
                    {
                        NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Error,
                            Summary = "Error Updating Car",
                            Detail = string.Join("; ", result.Errors),
                            Duration = 4000
                        });
                    }
                })
            }
        };

        // await DialogService.OpenAsync<EditCarDialog>("Edit Car", parameters, new DialogOptions { Width = "500px", Height = "auto" });
    }

    public void Dispose()
    {
        isDisposed = true;
    }








}